<!doctype html>

<html lang="en">

  <head>
    <meta charset="utf-8">
    <title>Infection Trajectory</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <style>
      body { margin: 0px; }
      #main { height: 100vh; }
    </style>
  </head>

  <body>
    <div id="main"><canvas id="chart"></canvas></div>
  </body>

  <script>
    var number = new Intl.NumberFormat();

    var chart = new Chart('chart', {
      type: 'line',
      data: {
        labels: [],
        datasets: [],
      },
      options: {
        resposive: true,
        maintainAspectRatio: false, 
        elements: {
          line: {
            fill: false,
            borderWidth: 2,
            lineTension: 0,
          },
        },
        tooltips: {
          mode: 'x',
          bodyAlign: 'right',
          itemSort: (a, b) => b.yLabel - a.yLabel,
          callbacks: {
            label: (item, data) => {
              return data.datasets[item.datasetIndex].label + ': ' + number.format(item.yLabel);
            },
          },
        },
        scales: {
          xAxes: [{
            display: true,
            scaleLabel: {
              display: true,
              labelString: 'Days after 100 cases',
            },
          }],
          yAxes: [{
            display: true,
            scaleLabel: {
              display: true,
              labelString: 'Growth factor',
            },
          }],
        },
      },
    });

    async function start() {
      let country = 'Germany';
      let max_days = 0;

      if (r = window.location.href.match(/\?country=(.*)$/)) {
        country = r[1];
      }

      const response = await fetch('https://pomber.github.io/covid19/timeseries.json');
      const data = await response.json();

      function add_country(country, color, special = false) {
        let result = [];

        let prev;
        for (const {date, confirmed} of data[country]) {
          const time = Date.parse(date);
          if (confirmed < 100) {
            prev = confirmed;
            continue;
          }
          result.push(confirmed / prev);
          prev = confirmed;
        }

        if (max_days < result.length) max_days = result.length;

        const dataset = {
          label: country,
          data: result,
          borderColor: color,
          backgroundColor: color,
        };

        if (special) {
          dataset.borderWidth = 4;
          dataset.pointStyle = 'rectRot';
        }

        chart.data.datasets.push(dataset);
      }

      add_country(country, 'hsl(270, 75%, 50%)', true);
      add_country('Italy', 'hsl(0, 75%, 50%)');
      add_country('Iran', 'hsl(30, 75%, 50%)');
      add_country('Spain', 'hsl(60, 75%, 50%)');
      add_country('US', 'hsl(90, 75%, 50%)');
      add_country('United Kingdom', 'hsl(120, 75%, 50%)');
      add_country('Korea, South', 'hsl(150, 75%, 50%)');
      add_country('Japan', 'hsl(180, 75%, 50%)');

      chart.data.labels = Array.apply(undefined, Array(max_days)).map((e, i) => i + 1);
      chart.update();
    }

    start();
  </script>

</html>
